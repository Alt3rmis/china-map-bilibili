/**
 * Bç«™æ•°æ®è·å–è„šæœ¬ï¼ˆæµè§ˆå™¨ç‰ˆæœ¬ï¼‰
 * åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œæ­¤è„šæœ¬ï¼Œè·å–"å¿«é€’é‡Œçš„ä¸­å›½"åˆé›†çš„æ‰€æœ‰è§†é¢‘æ•°æ®
 *
 * ä½¿ç”¨æ–¹æ³•ï¼š
 * 1. ç™»å½• Bç«™
 * 2. æ‰“å¼€åˆé›†é¡µé¢å¹¶æŒ‰ F12 æ‰“å¼€æ§åˆ¶å°
 * 3. å¤åˆ¶æœ¬è„šæœ¬å†…å®¹åˆ°æ§åˆ¶å°è¿è¡Œ
 * 4. ç­‰å¾…å®Œæˆåï¼Œå¤åˆ¶è¾“å‡ºçš„ data.js ä»£ç 
 */

// é…ç½®å‚æ•°
const CONFIG = {
    mid: 238365787,           // UPä¸»ID
    seasonId: 475111,          // åˆé›†ID
    pageSize: 30,               // æ¯é¡µæ•°é‡
    maxPages: 50                // æœ€å¤§è·å–é¡µæ•°ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
};

// è·å–æ‰€æœ‰é¡µé¢çš„æ•°æ®
async function fetchAllPages() {
    const allVideos = [];
    let page = 1;

    console.log('='.repeat(60));
    console.log('Bç«™æ•°æ®è·å–å·¥å…·');
    console.log('åˆé›†ï¼šå¿«é€’é‡Œçš„ä¸­å›½');
    console.log('='.repeat(60));

    while (page <= CONFIG.maxPages) {
        try {
            const url = `https://api.bilibili.com/x/polymer/web-space/seasons_archives_list` +
                `?mid=${CONFIG.mid}` +
                `&season_id=${CONFIG.seasonId}` +
                `&sort_reverse=false` +
                `&page_size=${CONFIG.pageSize}` +
                `&page_num=${page}` +
                `&web_location=333.1387`;

            const response = await fetch(url);
            const data = await response.json();

            // æ£€æŸ¥æ˜¯å¦æˆåŠŸ
            if (data.code === 0 && data.data) {
                const archives = data.data.archives || [];

                // ä¼˜åŒ–ï¼šæ£€æŸ¥æœ¬æ¬¡è·å–çš„è§†é¢‘æ•°é‡
                if (archives.length < CONFIG.pageSize) {
                    console.log(`\nâœ“ ç¬¬ ${page} é¡µè·å– ${archives.length} ä¸ªè§†é¢‘`);
                    console.log(`  â†’ æœ¬æ¬¡è·å–æ•°é‡å°‘äº ${CONFIG.pageSize}ï¼Œè¯´æ˜å·²æŸ¥å®Œ`);

                    // æ·»åŠ æœ€åä¸€é¡µçš„æ‰€æœ‰è§†é¢‘ååœæ­¢
                    const pageVideos = archives.map(archive => ({
                        title: archive.title,
                        bvid: archive.bvid,
                        aid: archive.aid,
                        ctime: archive.ctime,
                        pubtime: archive.pubtime,
                        // è·å–ç»Ÿè®¡æ•°æ®
                        view: archive.stat ? archive.stat.view || 0 : 0,
                        danmaku: archive.stat ? archive.stat.danmaku || 0 : 0,
                        // è§£ææ ‡é¢˜ä¸­çš„åŸå¸‚ä¿¡æ¯
                        city: parseCityFromTitle(archive.title)
                    }));

                    allVideos.push(...pageVideos);

                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®ï¼ˆé€šè¿‡ total å­—æ®µï¼‰
                    if (data.data.page && data.data.page.total) {
                        const total = data.data.page.total || 0;
                        if (total > allVideos.length) {
                            console.log(`\n  â†’ è¿˜æœ‰ ${total - allVideos.length} ä¸ªè§†é¢‘æœªè·å–`);
                            console.log(`  â†’ æ€»è§†é¢‘æ•°: ${total}`);
                            page++;
                            continue;
                        }
                    }

                    // å¦‚æœ total å­—æ®µä¸å­˜åœ¨æˆ–å·²è·å–å®Œæ¯•ï¼Œåœæ­¢
                    console.log(`\nâœ“ æ•°æ®è·å–å®Œæˆ`);
                    break;
                } else {
                    console.log(`\nâœ“ ç¬¬ ${page} é¡µè·å–æˆåŠŸï¼Œå…± ${archives.length} ä¸ªè§†é¢‘`);
                    allVideos.push(...archives.map(archive => ({
                        title: archive.title,
                        bvid: archive.bvid,
                        aid: archive.aid,
                        ctime: archive.ctime,
                        pubtime: archive.pubtime,
                        view: archive.stat ? archive.stat.view || 0 : 0,
                        danmaku: archive.stat ? archive.stat.danmaku || 0 : 0,
                        city: parseCityFromTitle(archive.title)
                    })));

                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µ
                    if (data.data.page && data.data.page.total < allVideos.length) {
                        break;
                    }

                    page++;
                }
            } else {
                console.error('\nâŒ API è¿”å›é”™è¯¯:', data);
                if (data.message) {
                    console.error('é”™è¯¯ä¿¡æ¯:', data.message);
                }
                break;
            }
        } catch (error) {
            console.error(`\nâŒ è·å–ç¬¬ ${page} é¡µå¤±è´¥:`, error);
            console.error('é”™è¯¯è¯¦æƒ…:', error.message || error);
            break;
        }
    }

    return allVideos;
}

// ä»æ ‡é¢˜ä¸­è§£æåŸå¸‚ä¿¡æ¯
function parseCityFromTitle(title) {
    // å°è¯•å¤šç§æ ‡é¢˜æ ¼å¼

    // æ ¼å¼1: å¿«é€’é‡Œçš„ä¸­å›½ [åŸå¸‚å]: [æè¿°]
    // ä¾‹å¦‚: å¿«é€’é‡Œçš„ä¸­å›½ æˆéƒ½ï¼šè“‰åŸçš„å¿«é€’æ±Ÿæ¹–
    let match = title.match(/å¿«é€’é‡Œçš„ä¸­å›½\s+([^ï¼š:]+)[ï¼š:](.*)/);
    if (match) {
        return match[1].trim();
    }

    // æ ¼å¼2: [åŸå¸‚å]å¿«é€’é‡Œçš„ä¸­å›½[å¯é€‰æ–‡å­—]
    // ä¾‹å¦‚: æˆéƒ½å¿«é€’é‡Œçš„ä¸­å›½ï¼šè“‰åŸçš„å¿«é€’æ±Ÿæ¹–
    match = title.match(/^([^å¿«é€’]+)å¿«é€’é‡Œçš„ä¸­å›½/);
    if (match) {
        return match[1].trim();
    }

    // æ ¼å¼3: åŒ…å«åŸå¸‚åçš„é€šç”¨åŒ¹é…
    // å®Œæ•´çš„ä¸­å›½åŸå¸‚åˆ—è¡¨ï¼ˆåœ°çº§å¸‚+å¿çº§å¸‚ï¼‰
    const commonCities = [
        // ç›´è¾–å¸‚
        'åŒ—äº¬', 'ä¸Šæµ·', 'å¤©æ´¥', 'é‡åº†',
        // çœä¼šåŸå¸‚
        'å¹¿å·', 'æ·±åœ³', 'æˆéƒ½', 'æ­å·', 'å—äº¬', 'æ­¦æ±‰', 'é•¿æ²™', 'è¥¿å®‰', 'éƒ‘å·',
        'çŸ³å®¶åº„', 'å¤ªåŸ', 'åˆè‚¥', 'å—æ˜Œ', 'ç¦å·', 'å¦é—¨', 'å—å®', 'æµ·å£', 'æ˜†æ˜', 'è´µé˜³',
        'æ‹‰è¨', 'å…°å·', 'è¥¿å®', 'é“¶å·', 'ä¹Œé²æœ¨é½', 'å‘¼å’Œæµ©ç‰¹', 'é•¿æ˜¥', 'æ²ˆé˜³', 'å“ˆå°”æ»¨', 'æµå—',
        // æ²³åŒ—
        'å”å±±', 'ç§¦çš‡å²›', 'é‚¯éƒ¸', 'é‚¢å°', 'ä¿å®š', 'å¼ å®¶å£', 'æ‰¿å¾·', 'æ²§å·', 'å»ŠåŠ', 'è¡¡æ°´',
        'è¾›é›†', 'æ™‹å·', 'æ–°ä¹', 'éµåŒ–', 'è¿å®‰', 'æ­¦å®‰', 'å—å®«', 'æ²™æ²³', 'æ¶¿å·', 'å®šå·',
        'å®‰å›½', 'é«˜ç¢‘åº—', 'æ³Šå¤´', 'ä»»ä¸˜', 'é»„éª…', 'æ²³é—´', 'éœ¸å·', 'ä¸‰æ²³', 'æ·±å·',
        // å±±è¥¿
        'å¤§åŒ', 'é˜³æ³‰', 'é•¿æ²»', 'æ™‹åŸ', 'æœ”å·', 'æ™‹ä¸­', 'è¿åŸ', 'å¿»å·', 'ä¸´æ±¾', 'å•æ¢',
        'å¤äº¤', 'é«˜å¹³', 'ä»‹ä¼‘', 'æ°¸æµ', 'æ²³æ´¥', 'åŸå¹³', 'ä¾¯é©¬', 'éœå·', 'å­ä¹‰', 'æ±¾é˜³',
        // å†…è’™å¤
        'åŒ…å¤´', 'ä¹Œæµ·', 'èµ¤å³°', 'é€šè¾½', 'é„‚å°”å¤šæ–¯', 'å‘¼ä¼¦è´å°”', 'å·´å½¦æ·–å°”', 'ä¹Œå…°å¯Ÿå¸ƒ',
        'æ»¡æ´²é‡Œ', 'äºŒè¿æµ©ç‰¹', 'ä¹Œå…°æµ©ç‰¹', 'é˜¿å°”å±±', 'é”¡æ—æµ©ç‰¹', 'å·´å½¦æµ©ç‰¹', 'ä¸°é•‡', 'ç‰™å…‹çŸ³',
        // è¾½å®
        'å¤§è¿', 'éå±±', 'æŠšé¡º', 'æœ¬æºª', 'ä¸¹ä¸œ', 'é”¦å·', 'è¥å£', 'é˜œæ–°', 'è¾½é˜³', 'ç›˜é”¦', 'é“å²­', 'æœé˜³', 'è‘«èŠ¦å²›',
        'ç“¦æˆ¿åº—', 'æµ·åŸ', 'ä¸œæ¸¯', 'å‡¤åŸ', 'å‡Œæµ·', 'åŒ—é•‡', 'å¤§çŸ³æ¡¥', 'ç›–å·', 'ç¯å¡”', 'è°ƒå…µå±±', 'å¼€åŸ',
        // å‰æ—
        'å‰æ—', 'å››å¹³', 'è¾½æº', 'é€šåŒ–', 'ç™½å±±', 'æ¾åŸ', 'ç™½åŸ',
        'å…¬ä¸»å²­', 'æ¢…æ²³å£', 'é›†å®‰', 'ä¸´æ±Ÿ', 'å¤§å®‰', 'æ´®å—', 'ç²æ˜¥', 'é¾™äº•', 'å’Œé¾™', 'æ•¦åŒ–',
        // é»‘é¾™æ±Ÿ
        'é½é½å“ˆå°”', 'é¸¡è¥¿', 'é¹¤å²—', 'åŒé¸­å±±', 'å¤§åº†', 'ä¼Šæ˜¥', 'ä½³æœ¨æ–¯', 'ä¸ƒå°æ²³', 'ç‰¡ä¸¹æ±Ÿ', 'é»‘æ²³', 'ç»¥åŒ–',
        'ç»¥èŠ¬æ²³', 'åŒæ±Ÿ', 'è™æ—', 'å¯†å±±', 'å¯Œé”¦', 'æ¼ æ²³', 'é“åŠ›', 'å°šå¿—', 'äº”å¸¸', 'æµ·ä¼¦', 'è‚‡ä¸œ',
        // æ±Ÿè‹
        'è‹å·', 'æ— é”¡', 'å¸¸å·', 'å—é€š', 'è¿äº‘æ¸¯', 'æ·®å®‰', 'ç›åŸ', 'æ‰¬å·', 'é•‡æ±Ÿ', 'æ³°å·', 'å®¿è¿',
        'æ±Ÿé˜´', 'å®œå…´', 'æ–°æ²‚', 'é‚³å·', 'æº§é˜³', 'é‡‘å›', 'å¸¸ç†Ÿ', 'å¼ å®¶æ¸¯', 'æ˜†å±±', 'å¤ªä»“', 'å¯ä¸œ', 'å¦‚çš‹',
        // æµ™æ±Ÿ
        'å®æ³¢', 'æ¸©å·', 'å˜‰å…´', 'æ¹–å·', 'ç»å…´', 'é‡‘å', 'è¡¢å·', 'èˆŸå±±', 'å°å·', 'ä¸½æ°´',
        'å»ºå¾·', 'ä¸´å®‰', 'ä½™å§š', 'æ…ˆæºª', 'ç‘å®‰', 'ä¹æ¸…', 'æµ·å®', 'å¹³æ¹–', 'æ¡ä¹¡', 'è¯¸æš¨', 'åµŠå·',
        // å®‰å¾½
        'èŠœæ¹–', 'èšŒåŸ ', 'æ·®å—', 'é©¬éå±±', 'æ·®åŒ—', 'é“œé™µ', 'å®‰åº†', 'é»„å±±', 'æ»å·', 'é˜œé˜³', 'å®¿å·', 'å…­å®‰', 'äº³å·', 'æ± å·', 'å®£åŸ',
        'ç•Œé¦–', 'æ¡åŸ', 'å®å›½', 'å¤©é•¿', 'æ˜å…‰',
        // ç¦å»º
        'è†ç”°', 'ä¸‰æ˜', 'æ³‰å·', 'æ¼³å·', 'å—å¹³', 'é¾™å²©', 'å®å¾·',
        'ç¦æ¸…', 'é‚µæ­¦', 'æ­¦å¤·å±±', 'å»ºç“¯', 'æ°¸å®‰', 'çŸ³ç‹®', 'æ™‹æ±Ÿ', 'å—å®‰', 'é¾™æµ·', 'æ¼³å¹³',
        // æ±Ÿè¥¿
        'æ™¯å¾·é•‡', 'èä¹¡', 'ä¹æ±Ÿ', 'æ–°ä½™', 'é¹°æ½­', 'èµ£å·', 'å‰å®‰', 'å®œæ˜¥', 'æŠšå·', 'ä¸Šé¥¶',
        'ç‘æ˜Œ', 'ä¹å¹³', 'ç‘é‡‘', 'å¾·å…´', 'è´µæºª', 'æ¨Ÿæ ‘', 'ä¸°åŸ', 'é«˜å®‰',
        // å±±ä¸œ
        'é’å²›', 'æ·„åš', 'æ£åº„', 'ä¸œè¥', 'çƒŸå°', 'æ½åŠ', 'æµå®', 'æ³°å®‰', 'å¨æµ·', 'æ—¥ç…§', 'ä¸´æ²‚', 'å¾·å·', 'èŠåŸ', 'æ»¨å·', 'èæ³½',
        'èƒ¶å·', 'å³å¢¨', 'å¹³åº¦', 'è±è¥¿', 'æ»•å·', 'é¾™å£', 'è±é˜³', 'è±å·', 'æ‹›è¿œ', 'æ –éœ', 'é’å·', 'è¯¸åŸ', 'å¯¿å…‰',
        // æ²³å—
        'å¼€å°', 'æ´›é˜³', 'å¹³é¡¶å±±', 'å®‰é˜³', 'é¹¤å£', 'æ–°ä¹¡', 'ç„¦ä½œ', 'æ¿®é˜³', 'è®¸æ˜Œ', 'æ¼¯æ²³', 'ä¸‰é—¨å³¡', 'å—é˜³', 'å•†ä¸˜', 'ä¿¡é˜³', 'å‘¨å£', 'é©»é©¬åº—',
        'è¥é˜³', 'æ–°éƒ‘', 'ç™»å°', 'å·©ä¹‰', 'æ–°å¯†', 'åƒå¸ˆ', 'èˆé’¢', 'æ±å·', 'æ—å·', 'å«è¾‰', 'è¾‰å¿', 'æ²é˜³',
        // æ¹–åŒ—
        'é»„çŸ³', 'åå °', 'å®œæ˜Œ', 'è¥„é˜³', 'é„‚å·', 'è†é—¨', 'å­æ„Ÿ', 'è†å·', 'é»„å†ˆ', 'å’¸å®', 'éšå·',
        'å¤§å†¶', 'ä¸¹æ±Ÿå£', 'å®œéƒ½', 'å½“é˜³', 'ææ±Ÿ', 'è€æ²³å£', 'æ£é˜³', 'å®œåŸ', 'é’Ÿç¥¥', 'äº¬å±±', 'å®‰é™†',
        // æ¹–å—
        'æ ªæ´²', 'æ¹˜æ½­', 'è¡¡é˜³', 'é‚µé˜³', 'å²³é˜³', 'å¸¸å¾·', 'å¼ å®¶ç•Œ', 'ç›Šé˜³', 'éƒ´å·', 'æ°¸å·', 'æ€€åŒ–', 'å¨„åº•',
        'æµé˜³', 'é†´é™µ', 'éŸ¶å±±', 'è€’é˜³', 'å¸¸å®', 'æ­¦å†ˆ', 'æ±¨ç½—', 'ä¸´æ¹˜', 'æ´¥å¸‚', 'æ²…æ±Ÿ', 'èµ„å…´', 'æ´ªæ±Ÿ',
        // å¹¿ä¸œ
        'ç æµ·', 'æ±•å¤´', 'ä½›å±±', 'éŸ¶å…³', 'æ¹›æ±Ÿ', 'è‚‡åº†', 'æ±Ÿé—¨', 'èŒ‚å', 'æƒ å·', 'æ¢…å·', 'æ±•å°¾', 'æ²³æº', 'é˜³æ±Ÿ', 'æ¸…è¿œ', 'ä¸œè', 'ä¸­å±±', 'æ½®å·', 'æ­é˜³', 'äº‘æµ®',
        'ä¹æ˜Œ', 'å—é›„', 'å°å±±', 'å¼€å¹³', 'é¹¤å±±', 'æ©å¹³', 'å»‰æ±Ÿ', 'é›·å·', 'å´å·', 'åŒ–å·', 'ä¿¡å®œ', 'é«˜å·', 'å››ä¼š', 'å…´å®', 'é™†ä¸°', 'é˜³æ˜¥', 'è‹±å¾·', 'è¿å·', 'æ™®å®', 'ç½—å®š',
        // å¹¿è¥¿
        'æŸ³å·', 'æ¡‚æ—', 'æ¢§å·', 'åŒ—æµ·', 'é˜²åŸæ¸¯', 'é’¦å·', 'è´µæ¸¯', 'ç‰æ—', 'ç™¾è‰²', 'è´ºå·', 'æ²³æ± ', 'æ¥å®¾', 'å´‡å·¦',
        'å²‘æºª', 'ä¸œå…´', 'æ¡‚å¹³', 'åŒ—æµ', 'é–è¥¿', 'å¹³æœ', 'å‡­ç¥¥', 'åˆå±±', 'è”æµ¦', 'æ¨ªå·',
        // æµ·å—
        'ä¸‰äºš', 'ä¸‰æ²™', 'å„‹å·', 'äº”æŒ‡å±±', 'ç¼æµ·', 'æ–‡æ˜Œ', 'ä¸‡å®', 'ä¸œæ–¹',
        // å››å·
        'è‡ªè´¡', 'æ”€æèŠ±', 'æ³¸å·', 'å¾·é˜³', 'ç»µé˜³', 'å¹¿å…ƒ', 'é‚å®', 'å†…æ±Ÿ', 'ä¹å±±', 'å—å……', 'çœ‰å±±', 'å®œå®¾', 'å¹¿å®‰', 'è¾¾å·', 'é›…å®‰', 'å·´ä¸­', 'èµ„é˜³',
        'éƒ½æ±Ÿå °', 'å½­å·', 'é‚›å´ƒ', 'å´‡å·', 'å¹¿æ±‰', 'ä»€é‚¡', 'ç»µç«¹', 'æ±Ÿæ²¹', 'å³¨çœ‰å±±', 'é˜†ä¸­', 'åè“¥', 'ä¸‡æº', 'ç®€é˜³', 'è¥¿æ˜Œ',
        // è´µå·
        'å…­ç›˜æ°´', 'éµä¹‰', 'å®‰é¡º', 'æ¯•èŠ‚', 'é“œä»',
        'æ¸…é•‡', 'èµ¤æ°´', 'ä»æ€€', 'å‡¯é‡Œ', 'éƒ½åŒ€', 'å…´ä¹‰', 'ç¦æ³‰',
        // äº‘å—
        'æ›²é–', 'ç‰æºª', 'ä¿å±±', 'æ˜­é€š', 'ä¸½æ±Ÿ', 'æ™®æ´±', 'ä¸´æ²§',
        'å®‰å®', 'å®£å¨', 'è…¾å†²', 'æ¥šé›„', 'å¤§ç†', 'æ™¯æ´ª', 'èŠ’å¸‚', 'ç‘ä¸½',
        // è¥¿è—
        'æ—¥å–€åˆ™', 'æ˜Œéƒ½', 'æ—èŠ', 'å±±å—', 'é‚£æ›²',
        // é™•è¥¿
        'é“œå·', 'å®é¸¡', 'å’¸é˜³', 'æ¸­å—', 'å»¶å®‰', 'æ±‰ä¸­', 'æ¦†æ—', 'å®‰åº·', 'å•†æ´›',
        'å…´å¹³', 'éŸ©åŸ', 'åé˜´',
        // ç”˜è‚ƒ
        'é‡‘æ˜Œ', 'ç™½é“¶', 'å¤©æ°´', 'æ­¦å¨', 'å¼ æ–', 'å¹³å‡‰', 'é…’æ³‰', 'åº†é˜³', 'å®šè¥¿', 'é™‡å—',
        'ç‰é—¨', 'æ•¦ç…Œ', 'åˆä½œ',
        // é’æµ·
        'æµ·ä¸œ',
        'æ ¼å°”æœ¨', 'å¾·ä»¤å“ˆ',
        // å®å¤
        'çŸ³å˜´å±±', 'å´å¿ ', 'å›ºåŸ', 'ä¸­å«',
        'çµæ­¦', 'é’é“œå³¡',
        // æ–°ç–†
        'å…‹æ‹‰ç›ä¾', 'åé²ç•ª', 'å“ˆå¯†', 'æ˜Œå‰', 'åšå°”å¡”æ‹‰', 'å·´éŸ³éƒ­æ¥', 'é˜¿å…‹è‹', 'å…‹å­œå‹’è‹', 'å–€ä»€', 'å’Œç”°', 'ä¼ŠçŠ', 'å¡”åŸ', 'é˜¿å‹’æ³°',
        'é˜œåº·', 'åº“å°”å‹’', 'é˜¿å›¾ä»€', 'é˜¿å…‹è‹å¸‚', 'å–€ä»€å¸‚', 'å’Œç”°å¸‚', 'ä¼Šå®', 'å¥å±¯', 'å¡”åŸ', 'ä¹Œè‹', 'é˜¿å‹’æ³°'
    ];

    // æŒ‰åŸå¸‚åé•¿åº¦é™åºæ’åºï¼Œä¼˜å…ˆåŒ¹é…æ›´é•¿çš„åŸå¸‚åï¼ˆé¿å…"éå±±"åŒ¹é…åˆ°"é"ï¼‰
    commonCities.sort((a, b) => b.length - a.length);

    for (const city of commonCities) {
        if (title.includes(city) && title.includes('å¿«é€’é‡Œçš„ä¸­å›½')) {
            return city;
        }
    }

    console.warn(`âš ï¸  æ— æ³•è§£æåŸå¸‚: ${title}`);
    return null;
}

// æŒ‰åŸå¸‚åˆ†ç»„è§†é¢‘
function groupVideosByCity(videos) {
    const cityGroups = {};

    videos.forEach(video => {
        if (video.city) {
            if (!cityGroups[video.city]) {
                cityGroups[video.city] = {
                    videos: []
                };
            }

            // å¤„ç†æ—¥æœŸï¼šä½¿ç”¨ ctimeï¼ˆåˆ›å»ºæ—¶é—´ï¼‰æˆ– pubtimeï¼ˆå‘å¸ƒæ—¶é—´ï¼‰
            // å¦‚æœä¸¤è€…éƒ½æ— æ•ˆï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ
            let pubtime = video.pubtime || video.ctime;
            let date;
            if (pubtime && pubtime > 1000000000) {  // æœ‰æ•ˆçš„æ—¶é—´æˆ³ï¼ˆ2001å¹´ä»¥åï¼‰
                date = new Date(pubtime * 1000).toISOString().split('T')[0];
            } else {
                console.warn(`âš ï¸  æ— æ•ˆçš„å‘å¸ƒæ—¶é—´ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ: ${video.title}`);
                date = new Date().toISOString().split('T')[0];
            }

            cityGroups[video.city].videos.push({
                title: video.title,
                url: `https://www.bilibili.com/video/${video.bvid}`,
                date: date,
                // æ·»åŠ é¢å¤–å…ƒæ•°æ®
                aid: video.aid,
                bvid: video.bvid,
                views: video.view,
                danmaku: video.danmaku
            });
        }
    });

    return cityGroups;
}

// ç”Ÿæˆ data.js æ ¼å¼çš„è¾“å‡º
function generateDataJsOutput(cityGroups) {
    const sortedCities = Object.keys(cityGroups).sort();

    const citiesStr = sortedCities.map(city => {
        const cityVideos = cityGroups[city].videos.sort((a, b) =>
            new Date(b.date) - new Date(a.date)
        );

        const videosStr = cityVideos.map(video => {
            const title = video.title.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
            return `        {
                title: "${title}",
                url: "${video.url}",
                date: "${video.date}",
                // å¯é€‰å…ƒæ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
                aid: ${video.aid},
                views: ${video.views},
                danmaku: ${video.danmaku}
            }`;
        }).join(',\n');

        return `    "${city}": {
        videos: [
${videosStr}
        ]
    }`;
    }).join(',\n\n');

    const output = `// åŸå¸‚æ•°æ®é…ç½®
// åŸå¸‚åç§°éœ€è¦ä¸ ECharts åœ°å›¾æ•°æ®åŒ¹é…
// æ•°æ®æ¥æºï¼šå“”å“©å“”å“©UPä¸» è€çŒ«é±¼ä¸åƒé±¼
// æœ€åæ›´æ–°æ—¶é—´: ${new Date().toISOString()}

const cityData = {
${citiesStr}
};
`;

    return output;
}

// æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
function showStatistics(videos, cityGroups) {
    console.log('\n' + '='.repeat(60));
    console.log('ğŸ“Š æ•°æ®ç»Ÿè®¡');
    console.log('='.repeat(60));

    console.log(`\næ€»è§†é¢‘æ•°: ${videos.length}`);
    console.log(`è¯†åˆ«åŸå¸‚æ•°: ${Object.keys(cityGroups).length}`);

    // è®¡ç®—æ€»è§‚çœ‹æ•°å’Œå¼¹å¹•æ•°
    let totalViews = 0;
    let totalDanmaku = 0;
    videos.forEach(v => {
        totalViews += v.views || 0;
        totalDanmaku += v.danmaku || 0;
    });

    console.log(`\næ€»è§‚çœ‹æ•°: ${totalViews.toLocaleString()}`);
    console.log(`æ€»å¼¹å¹•æ•°: ${totalDanmaku.toLocaleString()}`);

    // æ˜¾ç¤ºæ¯ä¸ªåŸå¸‚çš„ç»Ÿè®¡
    console.log(`\nå„åŸå¸‚ç»Ÿè®¡:`);
    console.log('-'.repeat(60));

    Object.entries(cityGroups)
        .sort((a, b) => b[1].videos.length - a[1].videos.length)
        .forEach(([city, data], index) => {
            const videoCount = data.videos.length;
            const cityViews = data.videos.reduce((sum, v) => sum + (v.views || 0), 0);
            const cityDanmaku = data.videos.reduce((sum, v) => sum + (v.danmaku || 0), 0);

            console.log(`${index + 1}. ${city.padEnd(8, 'ã€€')}`);
            console.log(`   è§†é¢‘æ•°: ${videoCount}`);
            console.log(`   è§‚çœ‹æ•°: ${cityViews.toLocaleString()}`);
            console.log(`   å¼¹å¹•æ•°: ${cityDanmaku.toLocaleString()}`);
            console.log('-'.repeat(40));
        });
}

// ä¸»å‡½æ•°
async function main() {
    const videos = await fetchAllPages();

    if (videos.length === 0) {
        console.error('\nâŒ æœªè·å–åˆ°ä»»ä½•è§†é¢‘æ•°æ®');
        console.log('\nå¯èƒ½çš„åŸå› ï¼š');
        console.log('1. API éœ€è¦ç™»å½•æ€ - è¯·ç¡®ä¿å·²ç™»å½• Bç«™');
        console.log('2. ç½‘ç»œé—®é¢˜ - è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        console.log('3. API å˜æ›´ - Bç«™å¯èƒ½æ›´æ–°äº† API');
        console.log('\næ›¿ä»£æ–¹æ¡ˆï¼š');
        console.log('1. ç›´æ¥è®¿é—®åˆé›†é¡µé¢æ‰‹åŠ¨æŸ¥çœ‹');
        console.log('2. ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ç½‘ç»œé¢æ¿åˆ†æ API è¯·æ±‚');
        return;
    }

    const cityGroups = groupVideosByCity(videos);
    showStatistics(videos, cityGroups);

    // ç”Ÿæˆè¾“å‡º
    const output = generateDataJsOutput(cityGroups);

    console.log('\n' + '='.repeat(60));
    console.log('âœ“ æ•°æ®å‡†å¤‡å®Œæˆ');
    console.log('='.repeat(60));
    console.log('\nè¾“å‡º data.js æ ¼å¼çš„æ•°æ®ï¼š');
    console.log('='.repeat(60));
    console.log(output);
    console.log('\n' + '='.repeat(60));
    console.log('ğŸ“‹ ä½¿ç”¨æ–¹æ³•ï¼š');
    console.log('1. å¤åˆ¶ä¸Šé¢ data.js æ ¼å¼çš„ä»£ç ');
    console.log('2. æ‰“å¼€ data/data.js æ–‡ä»¶');
    console.log('3. ç²˜è´´ä»£ç å¹¶ä¿å­˜');
    console.log('='.repeat(60));
}

// å¯¼å‡ºå‡½æ•°ä¾›å¤–éƒ¨è°ƒç”¨
window.fetchBilibiliData = main;
window.fetchAllPages = fetchAllPages;
window.groupVideosByCity = groupVideosByCity;
window.generateDataJsOutput = generateDataJsOutput;
window.showStatistics = showStatistics;

// å¦‚æœç›´æ¥è¿è¡Œè„šæœ¬ï¼Œè‡ªåŠ¨æ‰§è¡Œä¸»å‡½æ•°
if (typeof window !== 'undefined') {
    main();
}
